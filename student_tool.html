<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¯«ä½œåŠæ‰¹æ”¹å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- å¼•å…¥ OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    <!-- å¼•å…¥ Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color: 0.3s;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        /* Red button for evaluation */
        .button-secondary {
             background-color: #ef4444; /* red-500 */
             color: white;
             font-weight: bold;
             padding: 0.5rem 1rem;
             border-radius: 0.5rem;
             transition: background-color: 0.3s;
        }
        .button-secondary:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* Green button for generating examples */
        .button-generate {
             background-color: #10b981;
             color: white;
             font-weight: bold;
             padding: 0.5rem 1rem;
             border-radius: 0.5rem;
             transition: background-color: 0.3s;
        }
        .button-generate:hover {
            background-color: #059669;
        }
        .output-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 50px;
            white-space: pre-line;
        }
        .skeleton-loader {
            width: 100%;
            height: 60px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0f0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            border-radius: 0.5rem;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .output-box strong {
            color: #4f46e5;
            font-weight: 600;
        }
        .paragraph-guidance {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            background-color: #eef2ff;
            border-radius: 0.5rem;
            color: #4338ca;
            font-size: 0.875rem;
        }
        .paragraph-guidance h4 {
            font-weight: bold;
            color: #3730a3;
        }
        /* Styles for the feedback table */
        .output-box table {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .wavy-underline {
            text-decoration: underline wavy #ef4444;
        }
        .icon-button {
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 9999px;
            width: 2.5rem;
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color: 0.2s;
        }
        .icon-button:hover {
            background-color: #c7d2fe;
        }
        .icon-button.is-listening {
             background-color: #ef4444;
             color: white;
        }
        #loading-overlay {
            transition: opacity 0.3s;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 id="comp-title" class="text-4xl font-extrabold text-gray-800">ä½œæ–‡é¡Œç›®è¼‰å…¥ä¸­...</h1>
            <div id="comp-details" class="flex justify-center gap-x-4 text-gray-500 mt-2">
                <!-- ä½œæ–‡è©³ç´°è³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥é€™è£¡ -->
            </div>
        </header>

        <!-- ä¸»è¦åŠŸèƒ½å€ -->
        <main>
             <div class="relative mb-8">
                <span style="background-color: #f7fafc;" class="absolute -top-4 left-4 text-blue-600 text-lg font-bold px-2 z-10">å¯«ä½œå¼•å°</span>
                <div class="border-2 border-blue-600 rounded-lg p-2">
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h2 class="text-xl font-bold mb-2">å°ä½œå®¶ä½ å¥½ï¼šã€Œæœ‰äº†ä½œæ–‡å¤§ç¶±ï¼Œå¯«ä½œå°±æœ‰äº†æ–¹å‘ï¼ã€</h2>
                        <p class="text-gray-600 mb-4">æ ¹æ“šè€å¸«è¨­å®šçš„ä½œæ–‡æ–‡é«”å’Œä½œæ–‡çµæ§‹ï¼Œæä¾›ä½œæ–‡å¤§ç¶±èªªæ˜ï¼Œä¸€èµ·ä¾†æ²‰æµ¸å¼å¯«ä½œå§ï¼</p>
                        <div class="grid grid-cols-1 gap-4">
                            <button id="generate-paragraph-btn" class="button-primary w-full">ç”¢ç”Ÿä½œæ–‡å¤§ç¶±</button>
                        </div>
                        <div id="outline-content" class="output-box mt-4">
                            é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆå¯«ä½œå¤§ç¶±ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <div id="guidance-columns">
                <!-- å»ºè­°è©å½™ã€å¥å‹ã€ä¿®è¾­æœƒå‹•æ…‹è¼‰å…¥é€™è£¡ -->
            </div>
            
            <div class="relative mb-8">
                <span style="background-color: #f7fafc;" class="absolute -top-4 left-4 text-blue-600 text-lg font-bold px-2 z-10">å¯«ä½œæ‰¹æ”¹</span>
                <div class="border-2 border-blue-600 rounded-lg p-2">
                    <div class="bg-blue-50 rounded-lg p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-xl font-bold mb-2">å°ä½œå®¶ä½ å¥½ï¼šã€Œç¾åœ¨å¯ä»¥åƒè€ƒä½œæ–‡å¤§ç¶±ï¼Œé–‹å§‹å¯«ä½œå›‰ï¼ã€</h2>
                                <p class="text-gray-600">æ¯æ®µä½œæ–‡å¯«å®Œæ‰¹æ”¹å¾Œï¼Œå¯ä»¥ä¾ç…§å»ºè­°ä¿®æ”¹å†æ¬¡æ‰¹æ”¹ï¼Œä½œæ–‡èƒ½åŠ›é¦¬ä¸Šå¢å¼·ï¼</p>
                            </div>
                            <span id="word-counter" class="text-gray-600 font-medium">ç¸½å­—æ•¸ï¼š0 / 0</span>
                        </div>
                        <button id="populate-writing-area-btn" class="button-primary w-full my-4">ç”¢ç”Ÿå„æ®µä½œæ–‡å¤§ç¶±å’Œå¼•å°æå•</button>
                        <div id="writing-section" class="mt-4 space-y-4">
                            <!-- å››å€‹æ®µè½çš„å¯«ä½œå€å¡Š -->
                            <div id="p1-block" class="card bg-white">
                                <h3 class="text-lg font-bold text-gray-700 mb-4">ç¬¬ä¸€æ®µå¯«ä½œå€</h3>
                                <div id="paragraph-1-guidance"></div>
                                <textarea id="paragraph-1-input" class="w-full h-32 p-2 border rounded-md writing-textarea" placeholder="ç¬¬ä¸€æ®µ..."></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="flex items-center gap-2">
                                        <button title="èªéŸ³è¼¸å…¥" data-paragraph="1" class="icon-button voice-input-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0 3-3V3a3 3 0 0 0-6 0v2a3 3 0 0 0 3 3z"/></svg>
                                        </button>
                                        <button title="ä¸Šå‚³æª”æ¡ˆ" data-paragraph="1" class="icon-button file-upload-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1a.5.5 0 0 1 .5.5V3a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V1.5A.5.5 0 0 1 5 1h4.5z"/></svg>
                                        </button>
                                    </div>
                                    <button data-paragraph="1" class="button-secondary !w-auto text-sm">æ‰¹æ”¹ç¬¬ä¸€æ®µ</button>
                                </div>
                                <h4 class="text-md font-bold text-gray-700 mt-6 mb-2">ç¬¬ä¸€æ®µæ‰¹æ”¹çµæœå€</h4>
                                <div id="paragraph-1-feedback" class="output-box mt-0"></div>
                            </div>
                             <div id="p2-block" class="card bg-white">
                                <h3 class="text-lg font-bold text-gray-700 mb-4">ç¬¬äºŒæ®µå¯«ä½œå€</h3>
                                <div id="paragraph-2-guidance"></div>
                                <textarea id="paragraph-2-input" class="w-full h-32 p-2 border rounded-md writing-textarea" placeholder="ç¬¬äºŒæ®µ..."></textarea>
                                 <div class="flex justify-between items-center mt-2">
                                     <div class="flex items-center gap-2">
                                        <button title="èªéŸ³è¼¸å…¥" data-paragraph="2" class="icon-button voice-input-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0 3-3V3a3 3 0 0 0-6 0v2a3 3 0 0 0 3 3z"/></svg>
                                        </button>
                                        <button title="ä¸Šå‚³æª”æ¡ˆ" data-paragraph="2" class="icon-button file-upload-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1a.5.5 0 0 1 .5.5V3a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V1.5A.5.5 0 0 1 5 1h4.5z"/></svg>
                                        </button>
                                    </div>
                                     <button data-paragraph="2" class="button-secondary !w-auto text-sm">æ‰¹æ”¹ç¬¬äºŒæ®µ</button>
                                </div>
                                <h4 class="text-md font-bold text-gray-700 mt-6 mb-2">ç¬¬äºŒæ®µæ‰¹æ”¹çµæœå€</h4>
                                <div id="paragraph-2-feedback" class="output-box mt-0"></div>
                            </div>
                             <div id="p3-block" class="card bg-white">
                                <h3 class="text-lg font-bold text-gray-700 mb-4">ç¬¬ä¸‰æ®µå¯«ä½œå€</h3>
                                <div id="paragraph-3-guidance"></div>
                                <textarea id="paragraph-3-input" class="w-full h-32 p-2 border rounded-md writing-textarea" placeholder="ç¬¬ä¸‰æ®µ..."></textarea>
                                 <div class="flex justify-between items-center mt-2">
                                     <div class="flex items-center gap-2">
                                        <button title="èªéŸ³è¼¸å…¥" data-paragraph="3" class="icon-button voice-input-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0 3-3V3a3 3 0 0 0-6 0v2a3 3 0 0 0 3 3z"/></svg>
                                        </button>
                                        <button title="ä¸Šå‚³æª”æ¡ˆ" data-paragraph="3" class="icon-button file-upload-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1a.5.5 0 0 1 .5.5V3a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V1.5A.5.5 0 0 1 5 1h4.5z"/></svg>
                                        </button>
                                    </div>
                                    <button data-paragraph="3" class="button-secondary !w-auto text-sm">æ‰¹æ”¹ç¬¬ä¸‰æ®µ</button>
                                </div>
                                <h4 class="text-md font-bold text-gray-700 mt-6 mb-2">ç¬¬ä¸‰æ®µæ‰¹æ”¹çµæœå€</h4>
                                <div id="paragraph-3-feedback" class="output-box mt-0"></div>
                            </div>
                             <div id="p4-block" class="card bg-white">
                                <h3 class="text-lg font-bold text-gray-700 mb-4">ç¬¬å››æ®µå¯«ä½œå€</h3>
                                <div id="paragraph-4-guidance"></div>
                                <textarea id="paragraph-4-input" class="w-full h-32 p-2 border rounded-md writing-textarea" placeholder="ç¬¬å››æ®µ..."></textarea>
                                 <div class="flex justify-between items-center mt-2">
                                     <div class="flex items-center gap-2">
                                        <button title="èªéŸ³è¼¸å…¥" data-paragraph="4" class="icon-button voice-input-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0 3-3V3a3 3 0 0 0-6 0v2a3 3 0 0 0 3 3z"/></svg>
                                        </button>
                                        <button title="ä¸Šå‚³æª”æ¡ˆ" data-paragraph="4" class="icon-button file-upload-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1a.5.5 0 0 1 .5.5V3a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V1.5A.5.5 0 0 1 5 1h4.5z"/></svg>
                                        </button>
                                    </div>
                                    <button data-paragraph="4" class="button-secondary !w-auto text-sm">æ‰¹æ”¹ç¬¬å››æ®µ</button>
                                </div>
                                <h4 class="text-md font-bold text-gray-700 mt-6 mb-2">ç¬¬å››æ®µæ‰¹æ”¹çµæœå€</h4>
                                <div id="paragraph-4-feedback" class="output-box mt-0"></div>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <p class="text-xl font-bold mb-4">å°ä½œå®¶å®Œæˆæ•´ç¯‡æ–‡ç« äº†å—ï¼Ÿ</p>
                            <div class="text-left my-6 bg-white p-6 rounded-lg border">
                                <h4 class="font-semibold text-gray-800 mb-4 text-center">æ‰¹æ”¹å‰è‡ªæˆ‘æª¢æ ¸</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-y-2 gap-x-4">
                                    <div class="flex items-center">
                                        <input id="check1" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check1" class="ml-3 block text-sm text-gray-900">æ¯å€‹æ®µè½éƒ½æœ‰å®Œæˆäº†å—?</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check2" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check2" class="ml-3 block text-sm text-gray-900">æ¨™é»ç¬¦è™Ÿæœ‰æ­£ç¢ºä½¿ç”¨å—?</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check3" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check3" class="ml-3 block text-sm text-gray-900">æ³¨éŸ³åœ‹å­—æœ‰æ­£ç¢ºä½¿ç”¨å—?</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check4" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check4" class="ml-3 block text-sm text-gray-900">å»ºè­°è©å½™æœ‰ç›¡é‡ä½¿ç”¨å—?</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check5" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check5" class="ml-3 block text-sm text-gray-900">å»ºè­°å¥å‹æœ‰ç›¡é‡ä½¿ç”¨å—?</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check6" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="check6" class="ml-3 block text-sm text-gray-900">å»ºè­°ä¿®è¾­æœ‰ç›¡é‡ä½¿ç”¨å—?</label>
                                    </div>
                                </div>
                            </div>
                            <button id="evaluate-full-essay-btn" class="button-secondary w-full">æ‰¹æ”¹å…¨æ–‡</button>
                            <div id="full-essay-feedback" class="output-box mt-4 text-left"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card text-center bg-green-50">
                <h2 class="text-xl font-bold mb-4">éœ€è¦ä¸€é»éˆæ„Ÿå—ï¼Ÿ</h2>
                <button id="generate-full-comp-btn" class="button-primary">ç”¢ç”Ÿç¯„æ–‡</button>
                <div id="full-composition-output" class="output-box mt-4 text-left"></div>
            </div>

            <div class="card text-center bg-gray-100">
                <h2 class="text-xl font-bold mb-4">ä¸‹è¼‰å­¸ç¿’æ­·ç¨‹</h2>
                <p class="text-gray-600 mb-4">è«‹è¼¸å…¥æ‚¨çš„ç­ç´šåº§è™Ÿï¼Œä»¥ä¾¿ç‚ºæ‚¨çš„æª”æ¡ˆå‘½åã€‚</p>
                <input type="text" id="seat-number-input" class="w-full md:w-1/2 mx-auto p-2 border rounded-md text-center" placeholder="è¼¸å…¥å››ä½æ•¸ç­ç´šåº§è™Ÿ(ä¾‹å¦‚ï¼šå››å¹´äº”ç­1è™Ÿï¼Œè¼¸å…¥ï¼š4501)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <button id="download-guidance-btn" class="button-primary w-full bg-purple-600 hover:bg-purple-700">ä¸‹è¼‰å¼•å°å–® (æ–‡å­—æª”)</button>
                    <button id="download-history-btn" class="button-primary w-full bg-teal-600 hover:bg-teal-700">ä¸‹è¼‰å¯«ä½œæ­·ç¨‹åŠè©•åˆ†æª”æ¡ˆ(æ–‡å­—æª”)</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="file-uploader" class="hidden" accept=".txt,.pdf,.png,.jpg,.jpeg">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center">
      <div class="text-white text-xl text-center">
        <div class="mb-4 text-4xl animate-spin">â³</div>
        <p id="loading-status">æ­£åœ¨è¼‰å…¥...</p>
      </div>
    </div>

    <!-- Radar Chart Modal -->
    <div id="radar-chart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
      <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 id="radar-chart-title" class="text-lg leading-6 font-medium text-gray-900">å¯«ä½œèƒ½åŠ›é›·é”åœ–</h3>
          <div class="mt-2 px-7 py-3">
            <canvas id="radar-chart-canvas"></canvas>
          </div>
          <div class="items-center px-4 py-3">
            <button id="close-modal-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
              é—œé–‰
            </button>
          </div>
        </div>
      </div>
    </div>


    <script>
        let cvReady = false;
        function onOpenCvReady() {
            cvReady = true;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let previousScores = {}; // To store scores for comparison
            let previousFullEssayScores = null; // To store full essay scores for comparison
            let radarChartInstance = null; // To hold the chart instance
            let radarChartDatasets = {}; // To store datasets for each paragraph
            let activeParagraphForUpload = null; // To track which textarea to fill after upload
            let guidanceWordsData = null; 
            let exampleSentencesData = {};
            let paragraphHistory = { 1: [], 2: [], 3: [], 4: [] };
            let fullEssayHistory = [];

            const chartColors = [
                { border: 'rgb(255, 205, 86)', bg: 'rgba(255, 205, 86, 0.2)' }, // Yellow
                { border: 'rgb(75, 192, 192)', bg: 'rgba(75, 192, 192, 0.2)' }, // Green
                { border: 'rgb(255, 99, 132)', bg: 'rgba(255, 99, 132, 0.2)' }, // Red
                { border: 'rgb(54, 162, 235)', bg: 'rgba(54, 162, 235, 0.2)' }  // Blue
            ];
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingStatus = document.getElementById('loading-status');

            function showLoading(message) {
                loadingStatus.textContent = message;
                loadingOverlay.classList.remove('hidden');
            }

            function hideLoading() {
                loadingOverlay.classList.add('hidden');
            }


            // --- 1. GET PARAMETERS & API KEY ---
            const params = new URLSearchParams(window.location.search);
            const config = {
                title: params.get('title') || "æˆ‘æœ€å–œæ­¡çš„è§’è½",
                level: params.get('level') || "å››å¹´ç´š",
                wordCount: params.get('wordCount') || "400å­—",
                style: params.get('style') || "è¨˜æ•˜æ–‡",
                structure: params.get('structure') || "ç¸½åˆ†ç¸½",
                conjunctions: params.get('conjunctions')?.split(',') || ['å› ç‚º...æ‰€ä»¥...', 'ä¸ä½†...è€Œä¸”...', 'åªè¦...å°±...'],
                rhetoric: params.get('rhetoric')?.split(',') || ['è­¬å–»', 'æ’æ¯”']
            };
            const apiKey = sessionStorage.getItem('geminiApiKey') || ""; 

            if (!config.title) {
                document.body.innerHTML = '<h1 class="text-red-500 text-center text-xl p-8">éŒ¯èª¤ï¼šç¼ºå°‘ä½œæ–‡é¡Œç›®ã€‚è«‹è¿”å›ä¸Šä¸€é é‡æ–°è¨­å®šã€‚</h1>';
                return;
            }

            // --- 2. SETUP THE GEMINI API CALL FUNCTION ---
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            async function callGemini(prompt, elementToUpdate) {
                if (elementToUpdate) {
                    elementToUpdate.innerHTML = '<div class="skeleton-loader"></div>';
                }
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                    }
                    const data = await response.json();
                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json\n?|```html\n?|\n?```/g, '').trim();
                    if(elementToUpdate) {
                       elementToUpdate.innerHTML = text;
                    }
                    return text;
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    if(elementToUpdate) {
                       elementToUpdate.innerHTML = `<p style="color: red;">ç”Ÿæˆå¤±æ•—ï¼š${error.message}</p>`;
                    }
                    return null;
                }
            }

            // --- 3. DYNAMICALLY BUILD THE PAGE CONTENT ---
            function buildPage(guidanceWords) {
                document.getElementById('comp-title').textContent = config.title;
                const detailsBar = document.getElementById('comp-details');
                detailsBar.innerHTML = `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${config.level}</span>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">${config.wordCount}</span>
                    <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-sm">${config.style}</span>
                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-sm">${config.structure}</span>
                `;
                const guidanceContainer = document.getElementById('guidance-columns');

                const guidanceMap = {
                    phrases_vocab: { title: 'èªè©', options: guidanceWords?.phrases_vocab },
                    phrases_idioms: { title: 'æˆèª', options: guidanceWords?.phrases_idioms },
                    phrases_quotes: { title: 'åè¨€ä½³å¥', options: guidanceWords?.phrases_quotes },
                    conjunctions: { title: 'å»ºè­°å¥å‹', options: config.conjunctions },
                    rhetoric: { title: 'å»ºè­°ä¿®è¾­', options: config.rhetoric }
                };
                
                guidanceContainer.innerHTML = '';
                
                const treasureBoxWrapper = document.createElement('div');
                treasureBoxWrapper.className = 'relative mb-8';
                
                treasureBoxWrapper.innerHTML = `<span style="background-color: #f7fafc;" class="absolute -top-4 left-4 text-blue-600 text-lg font-bold px-2 z-10">å¯«ä½œç™¾å¯¶ç®±</span>`;
                
                const outerBox = document.createElement('div');
                outerBox.className = 'border-2 border-blue-600 rounded-lg p-2';
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'bg-blue-50 rounded-lg p-6 space-y-4';
                
                let hasContent = false;

                for (const key in guidanceMap) {
                    const item = guidanceMap[key];
                    if (item.options && item.options.length > 0 && item.options[0]) {
                        hasContent = true;
                        const card = document.createElement('div');
                        card.className = 'card bg-white'; 

                        if (key === 'phrases_vocab' || key === 'phrases_idioms' || key === 'phrases_quotes') {
                            let headerHTML = `<h3 class="font-bold text-lg mb-4">${item.title}</h3>`;
                            let itemsHTML = '<div class="flex flex-wrap gap-2">';
                            item.options.forEach(option => {
                                itemsHTML += `<span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">${option}</span>`;
                            });
                            itemsHTML += '</div>';
                            card.innerHTML = headerHTML + itemsHTML;
                        } else { 
                            const conjunctionMap = {
                                'å› ç‚º...æ‰€ä»¥...': 'å› æœè¤‡å¥',
                                'ä¸ä½†...è€Œä¸”...': 'ä¸¦åˆ—è¤‡å¥',
                                'åªè¦...å°±...': 'æ¢ä»¶è¤‡å¥',
                                'å¦‚æœ...å°±...': 'å‡è¨­è¤‡å¥',
                                'é›–ç„¶...ä½†æ˜¯...': 'è½‰æŠ˜è¤‡å¥'
                            };

                            let headerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg">${item.title}</h3>
                                    <button class="button-generate !w-auto !mt-0 flex-shrink-0" data-type="${key}">ç”Ÿæˆæ‰€æœ‰ç¯„ä¾‹</button>
                                </div>
                            `;

                            let itemsHTML = '<div class="space-y-4">';
                            item.options.forEach((option, index) => {
                                const displayText = key === 'conjunctions' ? (conjunctionMap[option] || option) : option;
                                itemsHTML += `
                                    <div class="grid md:grid-cols-8 gap-4 items-center">
                                        <div class="md:col-span-1 text-gray-700 font-medium">${displayText}</div>
                                        <div class="md:col-span-7 output-box !mt-0" id="${key}-${index}-output"></div>
                                    </div>
                                `;
                            });
                            itemsHTML += '</div>';
                            card.innerHTML = headerHTML + itemsHTML;
                        }
                        contentWrapper.appendChild(card);
                    }
                }

                if (hasContent) {
                    outerBox.appendChild(contentWrapper);
                    treasureBoxWrapper.appendChild(outerBox);
                    guidanceContainer.appendChild(treasureBoxWrapper);
                }
            }
            
            // --- 4. DEFINE API PROMPTS AND TRIGGER FUNCTIONS ---
            
            async function generateGuidanceWords() {
                showLoading('æ­£åœ¨ç”Ÿæˆå¯«ä½œå»ºè­°...');
                const prompt = `ä½ æ˜¯ä¸€ä½è‡ºç£åœ‹å°ä½œæ–‡è€å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹ä½œæ–‡é¡Œç›®ï¼Œç‚ºå­¸ç”Ÿæ¨è–¦é©åˆçš„è©å½™ã€‚
        - ä½œæ–‡é¡Œç›®: "${config.title}"

        è«‹æä¾›ä¸‰ç¨®é¡åˆ¥çš„å»ºè­°ï¼Œæ¯å€‹é¡åˆ¥åŒ…å«10å€‹é …ç›®ï¼š
        1.  **èªè©**: èˆ‡é¡Œç›®å ´æ™¯ã€ç‰©å“æˆ–æ„Ÿè¦ºç›¸é—œçš„æè¿°æ€§è©èªã€‚
        2.  **æˆèª**: é©åˆç”¨æ–¼æ–‡ç« ä¸­çš„æˆèªã€‚
        3.  **åè¨€ä½³å¥**: èˆ‡ä¸»é¡Œç›¸é—œçš„ç°¡çŸ­åè¨€ä½³å¥ã€‚

        è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹çš„ JSON æ ¼å¼è¼¸å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–èªªæ˜æ–‡å­—æˆ– markdown æ¨™ç±¤ã€‚
        {
          "phrases_vocab": ["èªè©ä¸€", "èªè©äºŒ", "...", "èªè©å"],
          "phrases_idioms": ["æˆèªä¸€", "æˆèªäºŒ", "...", "æˆèªå"],
          "phrases_quotes": ["åè¨€ä½³å¥ä¸€", "åè¨€ä½³å¥äºŒ", "...", "åè¨€ä½³å¥å"]
        }`;
                try {
                    const jsonText = await callGemini(prompt, null);
                    if (jsonText) {
                        return JSON.parse(jsonText);
                    }
                    return null;
                } catch (error) {
                    console.error("Failed to generate guidance words:", error);
                    return { phrases_vocab: [], phrases_idioms: [], phrases_quotes: [] };
                } finally {
                    hideLoading();
                }
            }
            
            async function generateParagraphStarters(targetElement) {
                const prompt = `ä½ æ˜¯ä¸€ä½è‡ºç£åœ‹å°ä½œæ–‡è€å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¨­å®šï¼Œåˆ†å››æ®µç°¡å–®èªªæ˜ä½œæ–‡çµæ§‹ã€‚
- ä½œæ–‡é¡Œç›®: "${config.title}"
- å­¸ç”Ÿå¹´ç´š: ${config.level}
- ä½œæ–‡çµæ§‹: ${config.structure}
- æ–‡é«”: ${config.style}
è«‹åˆ†å››æ®µç°¡å–®èªªæ˜ä½œæ–‡çµæ§‹ã€‚é‡è¦ï¼šæ®µè½å’Œæ®µè½ä¹‹é–“åªè¦ç©ºä¸€è¡Œå°±å¥½ï¼Œè«‹**ä¸è¦**åŠ å…¥ä»»ä½•åˆ†éš”ç·šï¼ˆä¾‹å¦‚ ---ï¼‰æˆ–æ•¸å­—ç·¨è™Ÿã€‚`;
                await callGemini(prompt, targetElement);
            }
            
            const detailedOutlinePrompt = `ä½ æ˜¯ä¸€ä½è‡ºç£åœ‹å°ä½œæ–‡è€å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¨­å®šï¼Œç‚ºä¸€ç¯‡å››æ®µå¼ä½œæ–‡ç”¢ç”Ÿä¸€ä»½è©³ç´°çš„å¯«ä½œå¤§ç¶±ã€‚
- ä½œæ–‡é¡Œç›®: "${config.title}"
- å­¸ç”Ÿå¹´ç´š: ${config.level}
- ä½œæ–‡çµæ§‹: ${config.structure}
- æ–‡é«”: ${config.style}

ä½ çš„ä»»å‹™æ˜¯ç‚ºæ¯ä¸€å€‹æ®µè½æä¾›ï¼š
1. ä¸€å€‹æ®µè½æ¨™é¡Œã€‚
2. ä¸€æ®µå£èªåŒ–ã€å¥½æ‡‚çš„å¯«ä½œèªªæ˜ã€‚
3. ä¸‰å€‹å¯ä»¥å¼•å°å­¸ç”Ÿæ€è€ƒçš„æå•ã€‚

è«‹å®Œå…¨ä¾ç…§ä»¥ä¸‹çš„ JSON æ ¼å¼è¼¸å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–èªªæ˜æ–‡å­—æˆ– markdown æ¨™ç±¤ã€‚
è¼¸å‡ºçš„ JSON å¿…é ˆæ˜¯ä¸€å€‹åŒ…å«å››å€‹ç‰©ä»¶çš„é™£åˆ—ã€‚æ¯ä¸€å€‹ç‰©ä»¶éƒ½å¿…é ˆåŒ…å«ä»¥ä¸‹ä¸‰å€‹éµï¼š
1. "title": (å­—ä¸²) æ®µè½æ¨™é¡Œã€‚
2. "explanation": (å­—ä¸²) è©²æ®µè½çš„å¯«ä½œèªªæ˜ã€‚
3. "questions": (å­—ä¸²é™£åˆ—) é‡å°è©²æ®µè½çš„ä¸‰å€‹å‹•è…¦æå•ã€‚`;
            
            async function populateWritingAreaWithOutline() {
                const tempDiv = document.createElement('div');
                const jsonText = await callGemini(detailedOutlinePrompt, tempDiv); 

                if (jsonText) {
                    try {
                        const outlineData = JSON.parse(jsonText);
                        if (Array.isArray(outlineData) && outlineData.length === 4) {
                            const paragraphPrefixes = ["ç¬¬ä¸€æ®µ", "ç¬¬äºŒæ®µ", "ç¬¬ä¸‰æ®µ", "ç¬¬å››æ®µ"];
                            outlineData.forEach((paragraph, index) => {
                                const guidanceDiv = document.getElementById(`paragraph-${index + 1}-guidance`);
                                if (guidanceDiv) {
                                    let questionsHTML = '';
                                    if (paragraph.questions && Array.isArray(paragraph.questions)) {
                                        questionsHTML = `<ul class="list-disc list-inside mt-2 pl-2">${paragraph.questions.map(q => `<li>${q}</li>`).join('')}</ul>`;
                                    }
                                    guidanceDiv.innerHTML = `<div class="paragraph-guidance"><h4>${paragraphPrefixes[index]}ï¼š${paragraph.title}</h4><p>${paragraph.explanation}</p>${questionsHTML}</div>`;
                                }
                                const textarea = document.getElementById(`paragraph-${index + 1}-input`);
                                if (textarea) {
                                    textarea.value = ''; // Clear textarea
                                }
                            });
                            updateWordCount();
                        } else {
                           throw new Error("API å›å‚³çš„è³‡æ–™æ ¼å¼ä¸ç¬¦ã€‚");
                        }
                    } catch (e) {
                        console.error("Failed to parse or populate detailed outline:", e);
                        const feedbackBox = document.getElementById('paragraph-1-feedback');
                        if(feedbackBox) {
                            feedbackBox.innerHTML = `<p style="color: red;">ç”¢ç”Ÿæ®µè½å»ºè­°å¤±æ•—ï¼š${e.message}</p>`;
                        }
                    }
                } else {
                     const feedbackBox = document.getElementById('paragraph-1-feedback');
                     if(feedbackBox) {
                         feedbackBox.innerHTML = `<p style="color: red;">ç”¢ç”Ÿæ®µè½å»ºè­°å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>`;
                     }
                }
            }
             async function generateExamples(type) {
                const itemMap = {
                    conjunctions: { title: 'å»ºè­°å¥å‹', options: config.conjunctions },
                    rhetoric: { title: 'å»ºè­°ä¿®è¾­', options: config.rhetoric }
                };
                const item = itemMap[type];
                if (!item || !item.options) return;

                item.options.forEach((_, index) => {
                    const outputBox = document.getElementById(`${type}-${index}-output`);
                    if(outputBox) outputBox.innerHTML = '<div class="skeleton-loader !h-12"></div>';
                });

                const highlightRule = (type === 'rhetoric')
                    ? `**é‡è¦è¦å‰‡ï¼š** åœ¨ä½ ç”¢ç”Ÿçš„ç¯„ä¾‹å¥ä¸­ï¼Œè«‹åªç”¨ <strong> å’Œ </strong> æ¨™ç±¤å°‡**æ§‹æˆè©²ä¿®è¾­çš„é—œéµèªè©**åŒ…èµ·ä¾†ã€‚ä¾‹å¦‚ï¼Œå°æ–¼ã€Œè­¬å–»ã€ä¿®è¾ï¼Œè‹¥å¥å­æ˜¯ã€Œæ›¸æœ¬æ˜¯æˆ‘çš„å¥½æœ‹å‹ã€ï¼Œä½ æ‡‰è©²åªæ¨™ç¤ºæ§‹æˆè­¬å–»çš„éƒ¨åˆ†ï¼Œå›å‚³ã€Œæ›¸æœ¬<strong>æ˜¯æˆ‘çš„å¥½æœ‹å‹</strong>ã€ã€‚å°æ–¼ã€Œæ’æ¯”ã€ï¼Œè‹¥å¥å­æ˜¯ã€Œæˆ‘å–œæ­¡è§’è½çš„å®‰éœï¼Œå–œæ­¡è§’è½çš„éš±å¯†ï¼Œå–œæ­¡è§’è½çš„å®‰å…¨æ„Ÿã€ï¼Œä½ æ‡‰è©²å›å‚³ã€Œæˆ‘<strong>å–œæ­¡è§’è½çš„å®‰éœï¼Œå–œæ­¡è§’è½çš„éš±å¯†ï¼Œå–œæ­¡è§’è½çš„å®‰å…¨æ„Ÿ</strong>ã€ã€‚`
                    : `**é‡è¦è¦å‰‡ï¼š** åœ¨ä½ ç”¢ç”Ÿçš„ç¯„ä¾‹å¥ä¸­ï¼Œè«‹åªç”¨ <strong> å’Œ </strong> æ¨™ç±¤å°‡ä½œç‚ºé—œè¯è©çš„ã€Œé …ç›®ã€æœ¬èº«åŒ…èµ·ä¾†ã€‚ä¾‹å¦‚ï¼Œå°æ–¼ã€Œå› ç‚º...æ‰€ä»¥...ã€ï¼Œè‹¥å¥å­æ˜¯ã€Œå› ç‚ºä»Šå¤©ä¸‹é›¨ï¼Œæ‰€ä»¥æˆ‘æ²’æœ‰å»å…¬åœ’ã€ï¼Œä½ æ‡‰è©²å›å‚³ã€Œ<strong>å› ç‚º</strong>ä»Šå¤©ä¸‹é›¨ï¼Œ<strong>æ‰€ä»¥</strong>æˆ‘æ²’æœ‰å»å…¬åœ’ã€ã€‚`;

                const prompt = `ä½ æ˜¯ä¸€ä½å°ç£åœ‹å°ä½œæ–‡è€å¸«ï¼Œæ­£åœ¨ç‚º${config.level}çš„å­¸ç”Ÿèªªæ˜å¯«ä½œã€‚
- ä½œæ–‡é¡Œç›®: "${config.title}"
- æˆ‘éœ€è¦ä½ é‡å°ã€Œ${item.title}ã€é€™å€‹é¡åˆ¥ï¼Œç‚ºä»¥ä¸‹çš„ã€Œé …ç›®åˆ—è¡¨ã€ä¸­çš„**æ¯ä¸€å€‹é …ç›®**ï¼Œéƒ½ç”¢ç”Ÿä¸€å€‹ç°¡å–®æ¸…æ¥šçš„ç¯„ä¾‹å¥å­ã€‚
- é …ç›®åˆ—è¡¨: ${item.options.join('ã€')}
- å¥å­å…§å®¹è«‹ç›¡é‡èˆ‡ä½œæ–‡é¡Œç›®æœ‰é—œã€‚
- ${highlightRule}
- **é‡è¦**: ä½ çš„å›è¦†ä¸­ï¼Œç¯„ä¾‹å¥å­çš„å…§å®¹**ä¸å¯ä»¥**å†é‡è¤‡ã€Œé …ç›®ã€æœ¬èº«çš„æ–‡å­—ã€‚ä¾‹å¦‚ï¼Œé …ç›®æ˜¯ã€Œå› ç‚º...æ‰€ä»¥...ã€ï¼Œä½ çš„ç¯„ä¾‹å¥å°±ç›´æ¥æ˜¯ã€Œ<strong>å› ç‚º</strong>...<strong>æ‰€ä»¥</strong>...ã€ï¼Œè€Œä¸æ˜¯ã€Œå› ç‚º...æ‰€ä»¥...ï¼š<strong>å› ç‚º</strong>...<strong>æ‰€ä»¥</strong>...ã€ã€‚
- è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹çš„ JSON æ ¼å¼è¼¸å‡ºï¼Œkey æ˜¯é …ç›®ï¼Œvalue æ˜¯å¸¶æœ‰ <strong> æ¨™ç±¤çš„ç¯„ä¾‹å¥ã€‚ä¸è¦æœ‰ä»»ä½•å…¶ä»–èªªæ˜æ–‡å­—æˆ– markdown æ¨™ç±¤ã€‚
ç¯„ä¾‹æ ¼å¼:
{
  "${item.options[0]}": "ç¯„ä¾‹å¥...",
  "${item.options[1]}": "ç¯„ä¾‹å¥..."
}`;
                
                const jsonText = await callGemini(prompt, null);

                if (jsonText) {
                    try {
                        const examples = JSON.parse(jsonText);
                        item.options.forEach((option, index) => {
                            const outputBox = document.getElementById(`${type}-${index}-output`);
                            if (outputBox) {
                                outputBox.innerHTML = examples[option] || '<span class="text-red-500">ç„¡æ³•ç”Ÿæˆæ­¤é …ç›®çš„ç¯„ä¾‹ã€‚</span>';
                                // Store the example sentence
                                if (!exampleSentencesData[type]) {
                                    exampleSentencesData[type] = {};
                                }
                                if (examples[option]) {
                                    exampleSentencesData[type][option] = examples[option].replace(/<[^>]*>?/gm, ''); // Store plain text
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Failed to parse examples JSON:", e);
                        item.options.forEach((_, index) => {
                            const outputBox = document.getElementById(`${type}-${index}-output`);
                            if(outputBox) outputBox.innerHTML = `<p style="color: red;">ç”Ÿæˆç¯„ä¾‹å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚</p>`;
                        });
                    }
                } else {
                   item.options.forEach((_, index) => {
                       const outputBox = document.getElementById(`${type}-${index}-output`);
                       if(outputBox) outputBox.innerHTML = `<p style="color: red;">ç”Ÿæˆç¯„ä¾‹å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>`;
                   });
                }
            }
            
            // --- UPDATED EVALUATION FUNCTION ---
            async function evaluateParagraph(paragraphNum, paragraphText, guidanceText) {
                const feedbackElement = document.getElementById(`paragraph-${paragraphNum}-feedback`);
                if (!paragraphText.trim()) {
                    feedbackElement.innerHTML = "è«‹å…ˆè¼¸å…¥å…§å®¹å†é€²è¡Œè©•é‡ã€‚"; return;
                }
                
                const currentText = document.getElementById(`paragraph-${paragraphNum}-input`).value;


                // Check for previous scores and prepare the prompt additions
                const lastScores = previousScores[paragraphNum];
                let previousScoresPromptSection = "";
                let scoreComparisonTask = "";
                let tableHeader = `<th scope="col" class="px-4 py-2 whitespace-nowrap">ç´šåˆ† / åˆ†æ•¸</th>`; // Default header
                let tableExampleRow = `<td class="px-4 py-2 whitespace-nowrap">å››ç´šåˆ† / 85</td>`; // Default example row cell

                if (lastScores) {
                    // If previous scores exist, build the part of the prompt that shows them
                    previousScoresPromptSection = `
### ä¸Šæ¬¡è©•åˆ†ç´€éŒ„:
- æ•´é«”è©•åˆ†: ${lastScores['æ•´é«”è©•åˆ†']}
- ç«‹æ„å–æ: ${lastScores['ç«‹æ„å–æ']}
- çµæ§‹çµ„ç¹”: ${lastScores['çµæ§‹çµ„ç¹”']}
- é£è©é€ å¥: ${lastScores['é£è©é€ å¥']}
- éŒ¯åˆ¥å­—èˆ‡æ¨™é»: ${lastScores['éŒ¯åˆ¥å­—èˆ‡æ¨™é»']}
`;
                    // Add a task for the AI to perform the comparison
                    scoreComparisonTask = `
- **é‡è¦**: å› ç‚ºæœ‰æä¾›ã€Œä¸Šæ¬¡è©•åˆ†ç´€éŒ„ã€ï¼Œè«‹åœ¨æ–°çš„è©•åˆ†è¡¨æ ¼ä¸­å¢åŠ ã€Œé€²æ­¥ / é€€æ­¥ã€æ¬„ä½ï¼Œä¸¦è¨ˆç®—æ–°èˆŠåˆ†æ•¸çš„å·®ç•°ï¼ˆä¾‹å¦‚ï¼š+5, -3, Â±0ï¼‰ã€‚`;
                    
                    // Update the table header and example row for the prompt's example
                    tableHeader = `<th scope="col" class="px-4 py-2 whitespace-nowrap">ç´šåˆ† / åˆ†æ•¸</th>
            <th scope="col" class="px-4 py-2 whitespace-nowrap">é€²æ­¥ / é€€æ­¥</th>`;
                    tableExampleRow = `<td class="px-4 py-2 whitespace-nowrap">äº”ç´šåˆ† / 90</td>
            <td class="px-4 py-2 whitespace-nowrap">+5</td>`;
                }

                const prompt = `ä½ æ˜¯ä¸€ä½éå¸¸æœ‰è€å¿ƒã€è¦ªåˆ‡ä¸”å–„äºé¼“å‹µçš„å°ç£åœ‹å°ä½œæ–‡è€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šã€Œæ®µè½å¤§ç¶±æç¤ºã€ï¼Œæ‰¹æ”¹å­¸ç”Ÿå¯«çš„å–®ä¸€æ®µè½ã€‚è«‹ç”¨è¶…ç´šå£èªåŒ–ã€æ´»æ½‘ä¸”ç¬¦åˆå­¸ç”Ÿå¹´ç´šçš„èªæ°£ï¼Œæä¾›ç°¡çŸ­ã€æ¸…æ¥šã€æ˜“è®€ä¸”å…·é«”çš„å›é¥‹ã€‚

### ä½œæ–‡æ•´é«”è¨­å®š:
- ä½œæ–‡é¡Œç›®: "${config.title}"
- å­¸ç”Ÿå¹´ç´š: ${config.level}
- æ–‡é«”: ${config.style}

### ç¬¬ ${paragraphNum} æ®µçš„å¤§ç¶±æç¤º:
\`\`\`
${guidanceText}
\`\`\`

### å­¸ç”Ÿå¯«çš„æ®µè½å…§å®¹:
\`\`\`
${paragraphText}
\`\`\`
${previousScoresPromptSection}
### ä½ çš„ä»»å‹™:
è«‹æ ¹æ“šå¤§ç¶±æç¤ºï¼Œæª¢æŸ¥å­¸ç”Ÿçš„å…§å®¹æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¸¦å®Œå…¨ä¾ç…§ä»¥ä¸‹çš„æ ¼å¼å’Œèªæ°£æä¾›å›é¥‹ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œè¡¨æƒ…ç¬¦è™Ÿã€‚
${scoreComparisonTask}
- **è©•åˆ†æ¨™æº–**: ã€Œç´šåˆ†ã€è«‹åƒè€ƒå°ç£åœ‹ä¸­æœƒè€ƒçš„å…­ç´šåˆ†åˆ¶ï¼ˆä¸€ç´šåˆ†è‡³å…­ç´šåˆ†ï¼‰ï¼Œå…­ç´šåˆ†ç‚ºæœ€é«˜åˆ†ã€‚ã€Œåˆ†æ•¸ã€ç‚º 0-100 åˆ†ã€‚
- **é‡è¦**: è«‹åœ¨ä½ çš„å›è¦†æœ€å¾Œï¼ŒåŠ ä¸Šä¸€å€‹åŒ…å«åˆ†æ•¸çš„ JSON ç‰©ä»¶ï¼Œä¸¦ç”¨ HTML è¨»è§£åŒ…èµ·ä¾†ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\\\`<!-- SCORES_JSON: {"æ•´é«”è©•åˆ†": 85, "ç«‹æ„å–æ": 88, "çµæ§‹çµ„ç¹”": 92, "é£è©é€ å¥": 82, "éŒ¯åˆ¥å­—èˆ‡æ¨™é»": 95} -->\\\`ã€‚JSON ä¸­çš„åˆ†æ•¸å¿…é ˆæ˜¯æ•¸å­—ã€‚
- **ç´…ç­†æ‰¹æ”¹**: åœ¨ã€Œå¯ä»¥åŠ å¼·çš„åœ°æ–¹ã€å’Œã€Œè€å¸«çš„å…·é«”å»ºè­°ã€ä¸­ï¼Œè‹¥æœ‰éœ€è¦å­¸ç”Ÿä¿®æ”¹çš„æ–‡å­—ï¼Œè«‹ç”¨ \`<span class="text-red-600 font-semibold">\` å’Œ \`</span>\` æ¨™ç±¤å°‡å…¶åŒ…è¦†èµ·ä¾†ï¼Œæ¨¡æ“¬è€å¸«ç”¨ç´…ç­†åŠƒè¨˜çš„æ•ˆæœã€‚åœ¨ã€Œå°ä½œå®¶å¯«ä½œå„ªé»ã€ä¸­ï¼Œå¦‚æœä½ è¦å¼•ç”¨å­¸ç”Ÿå¯«å¾—å¾ˆå¥½çš„å¥å­ï¼Œè«‹ç”¨ \`<span class="wavy-underline">\` å’Œ \`</span>\` æ¨™ç±¤å°‡å…¶åŒ…è¦†èµ·ä¾†ï¼Œæ¨¡æ“¬è€å¸«ç”¨ç´…ç­†ç•«æ³¢æµªç·šç¨±è®šçš„æ•ˆæœã€‚
- **æ ¼å¼å¤©æ¢ (çµ•å°ç¦æ­¢é•å)**: ä½ çš„å›è¦†ä¸­ï¼Œ**çµ•å°ä¸å¯ä»¥**åŒ…å«ä»»ä½• Markdown èªæ³•ï¼Œä¾‹å¦‚ "#"ã€"*" æˆ– "-"ã€‚æ‰€æœ‰æ¢åˆ—å¼é …ç›®éƒ½**å¿…é ˆ**ä»¥ã€Œãƒ»ã€é–‹é ­ã€‚æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šâœï¸ è€å¸«ä¾†æ‰¹æ”¹å›‰ï¼ï¼‰å¾Œé¢è«‹ç›´æ¥æ›è¡Œï¼Œä¸è¦æœ‰ä»»ä½•å¤šé¤˜çš„ç¬¦è™Ÿã€‚

### è¼¸å‡ºæ ¼å¼ (è«‹åš´æ ¼éµå®ˆæ‰€æœ‰ç´°ç¯€):

âœï¸ è€å¸«ç«‹å³ä¾†æ‰¹æ”¹ï¼

è©•èªï¼š
[åœ¨é€™è£¡å¯«ä¸€å¥ç¸½çµæ€§çš„è©•èªï¼Œå°±åƒåœ¨è·Ÿå°æœ‹å‹èŠå¤©ä¸€æ¨£ã€‚]

[è«‹åœ¨é€™è£¡ç”Ÿæˆä¸€å€‹ HTML è¡¨æ ¼ä¾†å‘ˆç¾è©•åˆ†çµæœã€‚è«‹ç›´æ¥è¼¸å‡º HTML åŸå§‹ç¢¼ï¼Œä¸è¦ç”¨ markdown åŒ…èµ·ä¾†ã€‚]
**è¡¨æ ¼ HTML ç¯„ä¾‹ (è«‹æ¨¡ä»¿æ­¤çµæ§‹èˆ‡ class):**
\`\`\`html
<table class="w-full text-sm text-left text-gray-500">
    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
        <tr>
            <th scope="col" class="px-4 py-2 rounded-tl-lg whitespace-nowrap">è©•åˆ†é …ç›®</th>
            ${tableHeader}
            <th scope="col" class="px-4 py-2 rounded-tr-lg">è€å¸«æ‚„æ‚„è©±</th>
        </tr>
    </thead>
    <tbody>
        <tr class="bg-white border-b font-bold text-indigo-700">
            <td class="px-4 py-2 whitespace-nowrap">æ•´é«”è©•åˆ†</td>
            ${tableExampleRow}
            <td class="px-4 py-2">å¾ˆä¸éŒ¯çš„é–‹å§‹ï¼Œæˆ‘å€‘ä¸€èµ·è®“å®ƒè®Šæ›´æ£’ï¼</td>
        </tr>
        <tr class="bg-gray-50 border-b">
            <td class="px-4 py-2 whitespace-nowrap">ç«‹æ„å–æ</td>
            ${tableExampleRow.replace('äº”ç´šåˆ† / 90', 'å››ç´šåˆ† / 88').replace('+5', '+2')}
            <td class="px-4 py-2">å…§å®¹å¾ˆæ£’ï¼Œæœ‰ç¬¦åˆå¤§ç¶±çš„æ–¹å‘å–”ï¼</td>
        </tr>
        <tr class="bg-white border-b">
            <td class="px-4 py-2 whitespace-nowrap">çµæ§‹çµ„ç¹”</td>
             ${tableExampleRow.replace('äº”ç´šåˆ† / 90', 'äº”ç´šåˆ† / 92').replace('+5', '+4')}
            <td class="px-4 py-2">å¥å­ä¹‹é–“çš„é€£æ¥å¾ˆé †æš¢ï¼</td>
        </tr>
        <tr class="bg-gray-50 border-b">
            <td class="px-4 py-2 whitespace-nowrap">é£è©é€ å¥</td>
             ${tableExampleRow.replace('äº”ç´šåˆ† / 90', 'å››ç´šåˆ† / 82').replace('+5', '-3')}
            <td class="px-4 py-2">è©èªå¯ä»¥ç”¨å¾—æ›´ç”Ÿå‹•ä¸€é»å–”ï¼</td>
        </tr>
        <tr class="bg-white">
            <td class="px-4 py-2 rounded-bl-lg whitespace-nowrap">éŒ¯åˆ¥å­—èˆ‡æ¨™é»</td>
             ${tableExampleRow.replace('äº”ç´šåˆ† / 90', 'å…­ç´šåˆ† / 95').replace('+5', 'Â±0')}
            <td class="px-4 py-2 rounded-br-lg">å“‡ï¼Œéƒ½æ²’æœ‰éŒ¯å­—ï¼Œå¤ªå²å®³äº†ï¼</td>
        </tr>
    </tbody>
</table>
\`\`\`

ğŸ‘ å°ä½œå®¶å¯«ä½œå„ªé»ï¼š
ãƒ»[è«‹ç”¨ã€Œãƒ»ã€é–‹é ­çš„æ¢åˆ—å¼èªªæ˜ã€‚ç¯„ä¾‹ï¼šãƒ»ä½ å¯«çš„ã€Œ<span class="wavy-underline">å¤ªé™½å…¬å…¬éœ²å‡ºäº†æº«æš–çš„ç¬‘è‡‰</span>ã€é€™å¥ï¼Œç”¨å¾—çœŸå¥½ï¼]

ğŸ’ª å¯ä»¥åŠ å¼·çš„åœ°æ–¹ï¼š
ãƒ»[è«‹ç”¨ã€Œãƒ»ã€é–‹é ­çš„æ¢åˆ—å¼èªªæ˜ã€‚ç¯„ä¾‹ï¼šãƒ»æˆ‘å€‘åŸæœ¬çš„å¤§ç¶±æ˜¯å¸Œæœ›ä½ å…ˆå¯«å‡º<span class="text-red-600 font-semibold">ã€Œåƒåˆ°å˜´å·´è£¡çš„å‘³é“ã€</span>ï¼Œä½†ä½ å…ˆå¯«äº†ã€Œç‚ºä»€éº¼æœƒåƒåˆ°ã€ï¼Œé †åºæœ‰é»ä¸ä¸€æ¨£ã€‚]

ğŸ’¡ è€å¸«çš„å…·é«”å»ºè­°ï¼š
ãƒ»[è«‹ç”¨ã€Œãƒ»ã€é–‹é ­çš„æ¢åˆ—å¼æä¾›å»ºè­°ã€‚ç¯„ä¾‹ï¼šãƒ»ä½ å¯ä»¥è©¦è‘—å›ç­”ï¼š<span class="text-red-600 font-semibold">ç¬¬ä¸€å£å’¬ä¸‹å»çš„è²éŸ³æ˜¯ä»€éº¼ï¼Ÿ</span>]

ğŸ‘‰ é–‹é ­å¥å­é€™æ¨£å¯«ï¼š
ãƒ»[è«‹ç”¨ã€Œãƒ»ã€é–‹é ­çš„æ¢åˆ—å¼æä¾›é©åˆçš„é–‹é ­å¥å­ã€‚]
`;
                // We handle the response manually to parse the scores
                feedbackElement.innerHTML = '<div class="skeleton-loader"></div>';
                const responseText = await callGemini(prompt, null);

                if (responseText) {
                    // 1. Extract and store scores
                    const scoreMatch = responseText.match(/<!-- SCORES_JSON: (.*) -->/);
                    if (scoreMatch && scoreMatch[1]) {
                        try {
                            const newScores = JSON.parse(scoreMatch[1]);
                            previousScores[paragraphNum] = newScores;
                            
                            // 2. Clean the response before displaying
                            const cleanedText = responseText.replace(/<!-- SCORES_JSON: .* -->/, '').trim();
                            feedbackElement.innerHTML = cleanedText;

                            // 3. Store history
                            paragraphHistory[paragraphNum].push({ text: currentText, feedback: cleanedText });
                            
                            // 4. Display the radar chart
                            displayRadarChart(newScores, paragraphNum);

                        } catch (e) {
                            console.error("Failed to parse scores JSON from AI response:", e);
                            // On failure, display the raw response but clean the comment if possible
                            feedbackElement.innerHTML = responseText.replace(/<!-- SCORES_JSON: .* -->/, '').trim();
                        }
                    } else {
                         // If no scores JSON found, just display the text as is
                         feedbackElement.innerHTML = responseText;
                         // Store history even if parsing fails
                         paragraphHistory[paragraphNum].push({ text: currentText, feedback: responseText });
                    }
                } else {
                    // Handle case where callGemini returned null
                    feedbackElement.innerHTML = `<p style="color: red;">ç”Ÿæˆè©•åˆ†å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>`;
                }
            }
            
            function displayRadarChart(scores, id) {
                const modal = document.getElementById('radar-chart-modal');
                const canvas = document.getElementById('radar-chart-canvas');
                const ctx = canvas.getContext('2d');
                const modalTitle = document.getElementById('radar-chart-title');
                
                const chineseNumerals = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››'];
                const titleText = (typeof id === 'string' && id.toLowerCase() === 'å…¨æ–‡')
                    ? 'å…¨æ–‡å¯«ä½œèƒ½åŠ›é›·é”åœ–'
                    : `ç¬¬ ${chineseNumerals[id - 1]} æ®µ å¯«ä½œèƒ½åŠ›é›·é”åœ–`;
                modalTitle.textContent = titleText;

                // Initialize dataset array for this id if it doesn't exist
                if (!radarChartDatasets[id]) {
                    radarChartDatasets[id] = [];
                }
                
                const datasetIndex = radarChartDatasets[id].length;
                const color = chartColors[datasetIndex % chartColors.length];

                const labels = ['ç«‹æ„å–æ', 'çµæ§‹çµ„ç¹”', 'é£è©é€ å¥', 'éŒ¯åˆ¥å­—èˆ‡æ¨™é»'];
                const dataPoints = [
                    scores['ç«‹æ„å–æ'] || 0,
                    scores['çµæ§‹çµ„ç¹”'] || 0,
                    scores['é£è©é€ å¥'] || 0,
                    scores['éŒ¯åˆ¥å­—èˆ‡æ¨™é»'] || 0,
                ];
                
                // Create the new dataset
                const newDataset = {
                    label: `ç¬¬ ${datasetIndex + 1} æ¬¡æ‰¹æ”¹`,
                    data: dataPoints,
                    fill: true,
                    backgroundColor: color.bg,
                    borderColor: color.border,
                    pointBackgroundColor: color.border,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: color.border
                };
                
                // Add the new dataset to the list for this id
                radarChartDatasets[id].push(newDataset);

                // Destroy the old chart instance if it exists
                if (radarChartInstance) {
                    radarChartInstance.destroy();
                }

                // Create a new chart with all the datasets for the current id
                radarChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: radarChartDatasets[id] // Use the array of datasets
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom',
                                align: 'center',
                                labels: {
                                    boxWidth: 15,
                                    padding: 20,
                                }
                            }
                        },
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                min: 50,
                                max: 100,
                                pointLabels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });

                modal.classList.remove('hidden');
            }


            async function generateFullComposition() {
                let allSuggestions = [];
                if (guidanceWordsData?.phrases_vocab) allSuggestions.push(...guidanceWordsData.phrases_vocab);
                if (guidanceWordsData?.phrases_idioms) allSuggestions.push(...guidanceWordsData.phrases_idioms);
                if (guidanceWordsData?.phrases_quotes) allSuggestions.push(...guidanceWordsData.phrases_quotes);
                if (config.conjunctions) allSuggestions.push(...config.conjunctions);
                if (config.rhetoric) allSuggestions.push(...config.rhetoric);

                const prompt = `ä½ æ˜¯ä¸€ä½å„ªç§€çš„ä½œå®¶ï¼Œè«‹ç‚ºä¸€ä½å°ç£çš„${config.level}å­¸ç”Ÿï¼Œæ ¹æ“šä»¥ä¸‹æ‰€æœ‰è¦æ±‚ï¼Œå¯«ä¸€ç¯‡æµæš¢ä¸”å®Œæ•´çš„ä½œæ–‡ã€‚

### ä½œæ–‡è¦æ±‚:
- **ä½œæ–‡é¡Œç›®**: "${config.title}"
- **å­—æ•¸è¦æ±‚**: æ¥è¿‘ ${config.wordCount.match(/\d+/)[0]} å­—ï¼Œä½†ä¸è¦è¶…éã€‚
- **æ–‡é«”**: ${config.style}
- **çµæ§‹**: ${config.structure}
- **èå…¥è©å½™**: è«‹åœ¨æ–‡ç« ä¸­ç›¡é‡èå…¥ä»¥ä¸‹çš„å»ºè­°è©èªã€æˆèªæˆ–å¥å‹: ${allSuggestions.join('ã€')}

### è¼¸å‡ºè¦å‰‡:
1.  **æ ¼å¼**:
    - ç¬¬ä¸€è¡Œæ˜¯ä½œæ–‡é¡Œç›®ï¼Œè«‹ç”¨ \`<h3 class="text-center text-2xl font-bold mb-4">${config.title}</h3>\` æ ¼å¼è¼¸å‡ºã€‚
    - æ–‡ç« æ®µè½è«‹ç”¨ \`<p>\` æ¨™ç±¤åŒ…è¦†ï¼Œä¸¦åœ¨æ®µè½é–‹é ­åŠ ä¸Šå…©å€‹å…¨å½¢ç©ºæ ¼ \`ã€€ã€€\` ä¾†ç¸®æ’ã€‚
2.  **æ¨™ç¤ºé‡é»**:
    - ç•¶ä½ åœ¨æ–‡ç« ä¸­ä½¿ç”¨åˆ°ä»»ä½•ä¾†è‡ªä¸Šæ–¹ã€Œèå…¥è©å½™ã€åˆ—è¡¨ä¸­çš„è©å½™æ™‚ï¼Œè«‹ç”¨ \`<span class="text-blue-600 font-semibold">\` å’Œ \`</span>\` æ¨™ç±¤å°‡è©²è©èªåŒ…èµ·ä¾†ã€‚
    - **è«‹ä¸è¦**ä½¿ç”¨ä»»ä½•å…¶ä»–çš„ HTML æ¨™ç±¤ (é™¤äº†æ®µè½ <p> å’Œæ¨™ç¤ºé‡é»çš„ <span>) æˆ– Markdown èªæ³• (ä¾‹å¦‚ \`**\`)ã€‚
3.  **å…§å®¹**:
    - å…§å®¹éœ€å…·é«”ï¼Œç”¨è©é©åˆåœ‹å°å­¸ç”Ÿç†è§£ã€‚
    - è«‹ç›´æ¥é–‹å§‹å¯«ä½œï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªã€‚`;
                await callGemini(prompt, document.getElementById('full-composition-output'));
            }
            
            function cleanFeedbackForTxt(html) {
                if (!html) return "å°šæœªæ‰¹æ”¹ã€‚";
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html.replace(/<!-- SCORES_JSON: .* -->/, '').trim();
                // Try to format tables a bit better
                tempDiv.querySelectorAll('table').forEach(table => {
                    let tableText = "\n--- è©•åˆ†è¡¨ ---\n";
                    table.querySelectorAll('tr').forEach(row => {
                        const cells = Array.from(row.querySelectorAll('th, td')).map(cell => cell.innerText.trim());
                        tableText += cells.join("\t|\t") + "\n";
                    });
                    tableText += "---------------\n";
                    table.replaceWith(document.createTextNode(tableText));
                });
                return tempDiv.innerText.trim();
            }

            function downloadHistoryFile() {
                const seatNumber = document.getElementById('seat-number-input').value;
                const filename = `${seatNumber || '0000'}_${config.title}_å¯«ä½œæ­·ç¨‹åŠè©•åˆ†.txt`;

                let content = "ä½œæ–‡å¼•å°å–®\n";
                content += "========================================\n\n";

                // 1. ä½œæ–‡é¡Œç›®èˆ‡è¨­å®š
                content += "ã€ä½œæ–‡é¡Œç›®ã€‘\n";
                content += document.getElementById('comp-title').innerText + "\n\n";
                content += "ã€ä½œæ–‡è¨­å®šã€‘\n";
                content += `å¹´ç´šï¼š${config.level}\n`;
                content += `å­—æ•¸ï¼š${config.wordCount}\n`;
                content += `æ–‡é«”ï¼š${config.style}\n`;
                content += `çµæ§‹ï¼š${config.structure}\n\n`;

                // 2. å¯«ä½œæ­·ç¨‹
                content += "========================================\n";
                content += "ã€å„æ®µå¯«ä½œæ­·ç¨‹ã€‘\n";
                content += "========================================\n\n";

                const chineseNumerals = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››'];
                for (let i = 1; i <= 4; i++) {
                    content += `--- ç¬¬ ${chineseNumerals[i-1]} æ®µ ---\n\n`;
                    const history = paragraphHistory[i];
                    if (history.length === 0) {
                        content += "æœ¬æ®µå°šæœªå¯«ä½œæˆ–æ‰¹æ”¹ã€‚\n\n";
                    } else {
                        history.forEach((entry, index) => {
                            content += `[ ç¬¬ ${index + 1} æ¬¡å¯«ä½œå…§å®¹ ]\n`;
                            content += entry.text + "\n\n";
                            content += `[ ç¬¬ ${index + 1} æ¬¡æ‰¹æ”¹çµæœ ]\n`;
                            content += cleanFeedbackForTxt(entry.feedback) + "\n\n";
                        });
                    }
                }
                
                // 3. å…¨æ–‡æ‰¹æ”¹æ­·ç¨‹
                content += "========================================\n";
                content += "ã€å…¨æ–‡æ‰¹æ”¹æ­·ç¨‹ã€‘\n";
                content += "========================================\n\n";

                if (fullEssayHistory.length === 0) {
                    content += "å°šæœªé€²è¡Œå…¨æ–‡æ‰¹æ”¹ã€‚\n\n";
                } else {
                    fullEssayHistory.forEach((entry, index) => {
                        content += `--- ç¬¬ ${index + 1} æ¬¡å…¨æ–‡æ‰¹æ”¹ ---\n\n`;
                        content += "ã€å­¸ç”Ÿå…§æ–‡ã€‘:\n" + entry.text + "\n\n";
                        content += "ã€è€å¸«æ‰¹æ”¹ã€‘:\n" + cleanFeedbackForTxt(entry.feedback) + "\n\n";
                    });
                }

                // Create blob and download link
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function downloadGuidanceFile() {
                if (!guidanceWordsData) {
                    alert("è«‹å…ˆç­‰å¾…å¯«ä½œå»ºè­°ç”Ÿæˆå®Œç•¢ï¼");
                    return;
                }

                let content = "ä½œæ–‡å¼•å°å–®\n";
                content += "========================================\n\n";

                // 1. ä½œæ–‡é¡Œç›®èˆ‡è¨­å®š
                content += "ã€ä½œæ–‡é¡Œç›®ã€‘\n";
                content += document.getElementById('comp-title').innerText + "\n\n";
                content += "ã€ä½œæ–‡è¨­å®šã€‘\n";
                content += `å¹´ç´šï¼š${config.level}\n`;
                content += `å­—æ•¸ï¼š${config.wordCount}\n`;
                content += `æ–‡é«”ï¼š${config.style}\n`;
                content += `çµæ§‹ï¼š${config.structure}\n\n`;

                // 2. ä½œæ–‡å¤§ç¶±
                content += "========================================\n";
                content += "ã€ä½œæ–‡å¤§ç¶±ã€‘\n";
                const outlineContent = document.getElementById('outline-content').innerText;
                content += (outlineContent.trim() !== "é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆå¯«ä½œå¤§ç¶±ã€‚") ? outlineContent + "\n\n" : "å°šæœªç”Ÿæˆå¤§ç¶±ã€‚\n\n";
                
                // 3. å„æ®µå¯«ä½œæç¤º
                content += "========================================\n";
                content += "ã€å„æ®µå¯«ä½œæç¤ºã€‘\n";
                let detailedGuidanceContent = '';
                let hasDetailedGuidance = false;
                for (let i = 1; i <= 4; i++) {
                    const guidanceElement = document.getElementById(`paragraph-${i}-guidance`);
                    if (guidanceElement && guidanceElement.innerText.trim() !== '') {
                        detailedGuidanceContent += guidanceElement.innerText + '\n\n';
                        hasDetailedGuidance = true;
                    }
                }
                content += hasDetailedGuidance ? detailedGuidanceContent : "å°šæœªç”Ÿæˆå„æ®µå¼•å°æå•ã€‚\n\n";


                // 4. å¯«ä½œç™¾å¯¶ç®±
                content += "========================================\n";
                content += "ã€å¯«ä½œç™¾å¯¶ç®±ã€‘\n\n";
                
                const guidanceMap = {
                    phrases_vocab: { title: 'èªè©', options: guidanceWordsData?.phrases_vocab },
                    phrases_idioms: { title: 'æˆèª', options: guidanceWordsData?.phrases_idioms },
                    phrases_quotes: { title: 'åè¨€ä½³å¥', options: guidanceWordsData?.phrases_quotes },
                    conjunctions: { title: 'å»ºè­°å¥å‹', options: config.conjunctions },
                    rhetoric: { title: 'å»ºè­°ä¿®è¾­', options: config.rhetoric }
                };

                for (const key in guidanceMap) {
                    const item = guidanceMap[key];
                    if (item.options && item.options.length > 0 && item.options[0]) {
                        content += `--- ${item.title} ---\n`;
                        if (key === 'conjunctions' || key === 'rhetoric') {
                             item.options.forEach(option => {
                                 const example = exampleSentencesData[key]?.[option] || "å°šæœªç”Ÿæˆç¯„ä¾‹";
                                 content += `${option}: ${example}\n`;
                             });
                             content += "\n";
                        } else {
                            content += item.options.join('ã€ ') + "\n\n";
                        }
                    }
                }

                // 5. éˆæ„Ÿç¯„æ–‡
                content += "========================================\n";
                content += "ã€éˆæ„Ÿç¯„æ–‡ã€‘\n";
                const fullCompContent = document.getElementById('full-composition-output').innerText;
                content += (fullCompContent.trim() !== "") ? fullCompContent + "\n\n" : "å°šæœªç”Ÿæˆç¯„æ–‡ã€‚\n\n";
                
                
                content += "========================================\n";
                content += "ã€æˆ‘çš„ä½œæ–‡ã€‘\n\n";
                content += "ç¬¬ä¸€æ®µï¼š\n\n\n\n";
                content += "ç¬¬äºŒæ®µï¼š\n\n\n\n";
                content += "ç¬¬ä¸‰æ®µï¼š\n\n\n\n";
                content += "ç¬¬å››æ®µï¼š\n\n\n\n";

                // Create blob and download link
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${config.title}_å¼•å°å–®.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }


            // --- 5. WORD COUNTER LOGIC & INPUT HANDLING ---
            const wordCountLimit = parseInt(config.wordCount.match(/\d+/)[0], 10);
            const wordCounterElement = document.getElementById('word-counter');
            const textareas = document.querySelectorAll('.writing-textarea');
            function updateWordCount() {
                let totalWords = 0;
                textareas.forEach(textarea => { totalWords += textarea.value.length; });
                wordCounterElement.textContent = `ç¸½å­—æ•¸ï¼š${totalWords} / ${wordCountLimit}`;
                if (totalWords > wordCountLimit) {
                    wordCounterElement.style.color = 'red';
                    wordCounterElement.style.fontWeight = 'bold';
                } else {
                    wordCounterElement.style.color = '';
                    wordCounterElement.style.fontWeight = '';
                }
            }

            function handleVoiceInput(paragraphNum, button) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ã€‚");
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                const textarea = document.getElementById(`paragraph-${paragraphNum}-input`);

                recognition.onstart = () => {
                    button.classList.add('is-listening');
                };

                recognition.onend = () => {
                    button.classList.remove('is-listening');
                };
                
                recognition.onerror = (event) => {
                    console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤:", event.error);
                    button.classList.remove('is-listening');
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    textarea.value += speechResult;
                    updateWordCount();
                };

                recognition.start();
            }

            async function handleFile(file) {
                if (!file) return;
                const textarea = document.getElementById(`paragraph-${activeParagraphForUpload}-input`);
                if (!textarea) return;

                const fileType = file.type;
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        textarea.value += e.target.result;
                        updateWordCount();
                    };
                    reader.readAsText(file);
                } else if (fileName.endsWith('.pdf')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                        const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                        let textContent = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const text = await page.getTextContent();
                            textContent += text.items.map(item => item.str).join(' ');
                        }
                        textarea.value += textContent;
                        updateWordCount();
                    };
                    reader.readAsArrayBuffer(file);
                } else if (fileType.startsWith('image/')) {
                    await processHandwritingImage(file, textarea);
                } else {
                    alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼è«‹ä¸Šå‚³ .txt, .pdf, æˆ–åœ–ç‰‡æª”ã€‚');
                }
            }
            
            async function processHandwritingImage(file, textarea) {
                if (!cvReady) {
                    alert("è¾¨è­˜å¼•æ“å°šæœªæº–å‚™å°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    return;
                }
                showLoading('æ­£åœ¨è™•ç†æ‚¨çš„æ‰‹å¯«åœ–ç‰‡...');

                try {
                    const imageURL = URL.createObjectURL(file);
                    const img = new Image();
                    img.src = imageURL;
                    
                    await new Promise(resolve => {
                        img.onload = resolve;
                    });
                    
                    showLoading('æ­¥é©Ÿ 1/3: å½±åƒæ ¡æ­£èˆ‡å¼·åŒ–...');
                    let src = cv.imread(img);
                    let gray = new cv.Mat();
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    let blurred = new cv.Mat();
                    cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                    let edged = new cv.Mat();
                    cv.Canny(blurred, edged, 75, 200);

                    let contours = new cv.MatVector();
                    let hierarchy = new cv.Mat();
                    cv.findContours(edged, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
                    
                    // Sort contours by area and find the biggest one
                    let sortedContours = [];
                    for (let i = 0; i < contours.size(); ++i) {
                        sortedContours.push({ contour: contours.get(i), area: cv.contourArea(contours.get(i)) });
                    }
                    sortedContours.sort((a, b) => b.area - a.area);

                    let screen_cnt = null;
                    for(let i = 0; i < Math.min(5, sortedContours.length); i++) {
                        let peri = cv.arcLength(sortedContours[i].contour, true);
                        let approx = new cv.Mat();
                        cv.approxPolyDP(sortedContours[i].contour, approx, 0.02 * peri, true);
                        if (approx.rows === 4) {
                             screen_cnt = approx;
                             break;
                        }
                        approx.delete();
                    }

                    let warped;
                    if (screen_cnt === null) {
                        console.log("Warning: æœªèƒ½è‡ªå‹•åµæ¸¬åˆ°4å€‹è§’é»ï¼Œå°‡ä½¿ç”¨æ•´å¼µåœ–ç‰‡é€²è¡Œå¾ŒçºŒè™•ç†ã€‚");
                        warped = gray.clone(); // Use the original gray image if detection fails
                    } else {
                        // Perspective transform logic
                        const pts = [];
                        for (let i = 0; i < screen_cnt.rows; i++) {
                            pts.push({ x: screen_cnt.data32S[i * 2], y: screen_cnt.data32S[i * 2 + 1] });
                        }

                        const rect = cv.minAreaRect(screen_cnt);
                        const center = rect.center;

                        // Sort points: tl, tr, br, bl
                        pts.sort((a, b) => a.y - b.y);
                        const top = pts.slice(0, 2).sort((a, b) => a.x - b.x);
                        const bottom = pts.slice(2, 4).sort((a, b) => a.x - b.x);
                        const [tl, tr] = top;
                        const [bl, br] = bottom;

                        const widthA = Math.sqrt(Math.pow(br.x - bl.x, 2) + Math.pow(br.y - bl.y, 2));
                        const widthB = Math.sqrt(Math.pow(tr.x - tl.x, 2) + Math.pow(tr.y - tl.y, 2));
                        const maxWidth = Math.max(widthA, widthB);

                        const heightA = Math.sqrt(Math.pow(tr.x - br.x, 2) + Math.pow(tr.y - br.y, 2));
                        const heightB = Math.sqrt(Math.pow(tl.x - bl.x, 2) + Math.pow(tl.y - bl.y, 2));
                        const maxHeight = Math.max(heightA, heightB);

                        const srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [tl.x, tl.y, tr.x, tr.y, br.x, br.y, bl.x, bl.y]);
                        const dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, maxWidth, 0, maxWidth, maxHeight, 0, maxHeight]);
                        
                        const M = cv.getPerspectiveTransform(srcTri, dstTri);
                        warped = new cv.Mat();
                        cv.warpPerspective(src, warped, M, new cv.Size(maxWidth, maxHeight));
                        cv.cvtColor(warped, warped, cv.COLOR_RGBA2GRAY);
                        srcTri.delete();
                        dstTri.delete();
                        M.delete();
                    }
                    
                    let enhanced = new cv.Mat();
                    let clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
                    clahe.apply(warped, enhanced);
                    
                    let binaryImage = new cv.Mat();
                    cv.adaptiveThreshold(enhanced, binaryImage, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 21, 10);
                    
                    // --- NEW STEP: Noise Removal using Morphological Operations ---
                    let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
                    let finalImage = new cv.Mat();
                    cv.morphologyEx(binaryImage, finalImage, cv.MORPH_OPEN, kernel);


                    // Create a canvas to pass to Tesseract.js
                    const canvas = document.createElement('canvas');
                    cv.imshow(canvas, finalImage);

                    src.delete(); gray.delete(); blurred.delete(); edged.delete(); contours.delete(); hierarchy.delete();
                    if(screen_cnt) screen_cnt.delete();
                    warped.delete(); enhanced.delete(); binaryImage.delete(); finalImage.delete(); clahe.delete(); kernel.delete();

                    showLoading('æ­¥é©Ÿ 2/3: è¼‰å…¥æ–‡å­—è¾¨è­˜å¼•æ“...');
                    const worker = await Tesseract.createWorker('chi_tra', 1, {
                        logger: m => {
                           if (m.status === 'recognizing text') {
                               showLoading(`æ­¥é©Ÿ 3/3: æ­£åœ¨è¾¨è­˜æ–‡å­—... (${(m.progress * 100).toFixed(0)}%)`);
                           }
                        },
                    });
                    
                    const { data: { text } } = await worker.recognize(canvas);
                    textarea.value += text;
                    updateWordCount();
                    await worker.terminate();
                } catch (error) {
                    console.error('æ‰‹å¯«è¾¨è­˜å¤±æ•—:', error);
                    alert(`æ‰‹å¯«è¾¨è­˜å¤±æ•—: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }


            // --- 6. INITIALIZE THE PAGE AND ADD EVENT LISTENNERS ---
            async function initializeApp() {
                guidanceWordsData = await generateGuidanceWords();
                buildPage(guidanceWordsData);

                document.getElementById('generate-paragraph-btn').addEventListener('click', () => {
                    generateParagraphStarters(document.getElementById('outline-content'));
                });
                document.getElementById('populate-writing-area-btn').addEventListener('click', populateWritingAreaWithOutline);
                document.getElementById('download-guidance-btn').addEventListener('click', downloadGuidanceFile);
                document.getElementById('download-history-btn').addEventListener('click', downloadHistoryFile);


                document.getElementById('guidance-columns').addEventListener('click', (e) => {
                    const button = e.target.closest('.button-generate');
                    if (button && button.dataset.type) {
                         generateExamples(button.dataset.type);
                    }
                });

                document.getElementById('generate-full-comp-btn').addEventListener('click', generateFullComposition);
                
                document.getElementById('writing-section').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    const paragraphNum = button.dataset.paragraph;

                    if (button.classList.contains('button-secondary')) { //æ‰¹æ”¹æŒ‰éˆ•
                        const paragraphText = document.getElementById(`paragraph-${paragraphNum}-input`).value;
                        const guidanceElement = document.getElementById(`paragraph-${paragraphNum}-guidance`);
                        const guidanceText = guidanceElement ? guidanceElement.innerText : "æ²’æœ‰æä¾›å¤§ç¶±æç¤º";
                        evaluateParagraph(paragraphNum, paragraphText, guidanceText);
                    } else if (button.classList.contains('voice-input-btn')) { //èªéŸ³è¼¸å…¥æŒ‰éˆ•
                         handleVoiceInput(paragraphNum, button);
                    } else if (button.classList.contains('file-upload-btn')) { //ä¸Šå‚³æª”æ¡ˆæŒ‰éˆ•
                        activeParagraphForUpload = paragraphNum;
                        document.getElementById('file-uploader').click();
                    }
                });

                document.getElementById('evaluate-full-essay-btn').addEventListener('click', evaluateFullEssay);
                
                document.getElementById('file-uploader').addEventListener('change', (e) => {
                    handleFile(e.target.files[0]);
                    e.target.value = ''; // Reset file input
                });
                
                textareas.forEach(textarea => {
                    textarea.addEventListener('input', updateWordCount);
                });
                
                const modal = document.getElementById('radar-chart-modal');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const closeModal = () => modal.classList.add('hidden');
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });

                updateWordCount();
            }

            async function evaluateFullEssay() {
                const feedbackElement = document.getElementById('full-essay-feedback');
                let fullText = "";
                for(let i = 1; i <= 4; i++) {
                    fullText += `ã€ç¬¬${i}æ®µã€‘\n` + document.getElementById(`paragraph-${i}-input`).value + "\n\n";
                }

                if (fullText.trim().length < 10) { // Check if there is substantial text
                    feedbackElement.innerHTML = "è«‹å…ˆå®Œæˆæ‰€æœ‰æ®µè½çš„å¯«ä½œå†é€²è¡Œå…¨æ–‡æ‰¹æ”¹ã€‚";
                    return;
                }

                let previousScoresPromptSection = "";
                let scoreComparisonTask = "";
                let tableHeader = `<th scope="col" class="px-4 py-2 whitespace-nowrap">ç´šåˆ† / åˆ†æ•¸</th>`;
                let tableExampleRow = `<td class="px-4 py-2 whitespace-nowrap">äº”ç´šåˆ† / 90</td>`;

                if (previousFullEssayScores) {
                    previousScoresPromptSection = `
### ä¸Šæ¬¡å…¨æ–‡è©•åˆ†ç´€éŒ„:
- æ•´é«”è¡¨ç¾: ${previousFullEssayScores['æ•´é«”è©•åˆ†']}
- ç«‹æ„å–æ: ${previousFullEssayScores['ç«‹æ„å–æ']}
- çµæ§‹çµ„ç¹”: ${previousFullEssayScores['çµæ§‹çµ„ç¹”']}
- é£è©é€ å¥: ${previousFullEssayScores['é£è©é€ å¥']}
- éŒ¯åˆ¥å­—èˆ‡æ¨™é»: ${previousFullEssayScores['éŒ¯åˆ¥å­—èˆ‡æ¨™é»']}
`;
                    scoreComparisonTask = `- **é‡è¦**: å› ç‚ºæœ‰æä¾›ã€Œä¸Šæ¬¡è©•åˆ†ç´€éŒ„ã€ï¼Œè«‹åœ¨æ–°çš„è©•åˆ†è¡¨æ ¼ä¸­å¢åŠ ã€Œé€²æ­¥ / é€€æ­¥ã€æ¬„ä½ï¼Œä¸¦è¨ˆç®—æ–°èˆŠåˆ†æ•¸çš„å·®ç•°ã€‚`;
                    tableHeader = `<th scope="col" class="px-4 py-2 whitespace-nowrap">ç´šåˆ† / åˆ†æ•¸</th><th scope="col" class="px-4 py-2 whitespace-nowrap">é€²æ­¥ / é€€æ­¥</th>`;
                    tableExampleRow = `<td class="px-4 py-2 whitespace-nowrap">å…­ç´šåˆ† / 95</td><td class="px-4 py-2 whitespace-nowrap">+5</td>`;
                }


                const prompt = `ä½ æ˜¯ä¸€ä½éå¸¸æœ‰è€å¿ƒã€è¦ªåˆ‡ä¸”å–„æ–¼é¼“å‹µçš„å°ç£åœ‹å°ä½œæ–‡è€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰¹æ”¹ä¸€ç¯‡å®Œæ•´çš„å››æ®µå¼ä½œæ–‡ã€‚

### ä½œæ–‡æ•´é«”è¨­å®š:
- ä½œæ–‡é¡Œç›®: "${config.title}"
- å­¸ç”Ÿå¹´ç´š: ${config.level}
- æ–‡é«”: ${config.style}
- ä½œæ–‡çµæ§‹: ${config.structure}

### å­¸ç”Ÿå¯«çš„å®Œæ•´æ–‡ç« :
\`\`\`
${fullText}
\`\`\`
${previousScoresPromptSection}

### ä½ çš„ä»»å‹™:
è«‹æ ¹æ“šæ•´ç¯‡æ–‡ç« çš„è¡¨ç¾ï¼Œæä¾›ä¸€ä»½ç¸½çµæ€§çš„æ‰¹æ”¹å ±å‘Šã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¼“å‹µçš„èªæ°£ã€‚
${scoreComparisonTask}
- **è©•åˆ†æ¨™æº–**: è«‹é‡å°æ•´ç¯‡æ–‡ç« çš„ã€Œç«‹æ„å–æã€ã€ã€Œçµæ§‹çµ„ç¹”ã€ã€ã€Œé£è©é€ å¥ã€ã€ã€ŒéŒ¯åˆ¥å­—èˆ‡æ¨™é»ã€å››å€‹å‘åº¦ï¼Œä»¥åŠã€Œæ•´é«”è¡¨ç¾ã€çµ¦äºˆè©•åˆ†ã€‚ã€Œç´šåˆ†ã€è«‹åƒè€ƒå°ç£åœ‹ä¸­æœƒè€ƒçš„å…­ç´šåˆ†åˆ¶ï¼Œã€Œåˆ†æ•¸ã€ç‚º 0-100 åˆ†ã€‚
- **é‡è¦**: è«‹åœ¨ä½ çš„å›è¦†æœ€å¾Œï¼ŒåŠ ä¸Šä¸€å€‹åŒ…å«åˆ†æ•¸çš„ JSON ç‰©ä»¶ï¼Œä¸¦ç”¨ HTML è¨»è§£åŒ…èµ·ä¾†ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\\\`<!-- SCORES_JSON: {"æ•´é«”è©•åˆ†": 88, "ç«‹æ„å–æ": 90, "çµæ§‹çµ„ç¹”": 85, "é£è©é€ å¥": 87, "éŒ¯åˆ¥å­—èˆ‡æ¨™é»": 90} -->\\\`ã€‚
- **ç´…ç­†æ¨™ç¤º**: è«‹æ‰¾å‡ºæ–‡ç« ä¸­ä¸€å…©å€‹å¯«å¾—**æœ€æ£’çš„å¥å­**ï¼Œç”¨ \`<span class="wavy-underline">\` æ¨™ç±¤åŒ…èµ·ä¾†å¼•ç”¨ã€‚åŒæ™‚ï¼Œä¹Ÿæ‰¾å‡ºéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œç”¨ \`<span class="text-red-600 font-semibold">\` æ¨™ç±¤åŒ…èµ·ä¾†æå‡ºå»ºè­°ã€‚
- **æ ¼å¼å¤©æ¢ (çµ•å°ç¦æ­¢é•å)**: ä½ çš„å›è¦†ä¸­ï¼Œ**çµ•å°ä¸å¯ä»¥**åŒ…å«ä»»ä½• Markdown èªæ³•ï¼Œä¾‹å¦‚ "#"ã€"*" æˆ– "-"ã€‚æ‰€æœ‰æ¢åˆ—å¼é …ç›®éƒ½**å¿…é ˆ**ä»¥ã€Œãƒ»ã€é–‹é ­ã€‚æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šâœï¸ ä½œæ–‡ç¸½é«”æª¢å ±å‘Šï¼‰å¾Œé¢è«‹ç›´æ¥æ›è¡Œï¼Œä¸è¦æœ‰ä»»ä½•å¤šé¤˜çš„ç¬¦è™Ÿã€‚

### è¼¸å‡ºæ ¼å¼ (è«‹åš´æ ¼éµå®ˆæ‰€æœ‰ç´°ç¯€):

âœï¸ æ•´ç¯‡ä½œæ–‡è©•åˆ†

è©•èªï¼š
[åœ¨é€™è£¡å¯«ä¸€å¥ç¸½çµæ€§ã€é¼“å‹µå­¸ç”Ÿçš„è©•èªã€‚]

[è«‹åœ¨é€™è£¡ç”Ÿæˆä¸€å€‹ HTML è¡¨æ ¼ä¾†å‘ˆç¾**æ•´ç¯‡æ–‡ç« **çš„ç¸½åˆ†ã€‚]
**è¡¨æ ¼ HTML ç¯„ä¾‹:**
\`\`\`html
<table class="w-full text-sm text-left text-gray-500">
    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
        <tr>
            <th scope="col" class="px-4 py-2 rounded-tl-lg whitespace-nowrap">è©•åˆ†é …ç›®</th>
            ${tableHeader}
            <th scope="col" class="px-4 py-2 rounded-tr-lg">è€å¸«æ‚„æ‚„è©±</th>
        </tr>
    </thead>
    <tbody>
        <tr class="bg-white border-b font-bold text-indigo-700">
            <td class="px-4 py-2 whitespace-nowrap">æ•´é«”è¡¨ç¾</td>
            ${tableExampleRow}
            <td class="px-4 py-2">é€™æ˜¯ä¸€ç¯‡å¾ˆæ£’çš„æ–‡ç« ï¼Œç¹¼çºŒä¿æŒï¼</td>
        </tr>
        <tr class="bg-gray-50 border-b">
            <td class="px-4 py-2 whitespace-nowrap">ç«‹æ„å–æ</td>
            ${tableExampleRow.replace('å…­ç´šåˆ† / 95', 'äº”ç´šåˆ† / 90').replace('+5', '+2')}
            <td class="px-4 py-2">ä¸»é¡Œæ˜ç¢ºï¼Œå…§å®¹ä¹Ÿå¾ˆå……å¯¦ã€‚</td>
        </tr>
        <tr class="bg-white border-b">
            <td class="px-4 py-2 whitespace-nowrap">çµæ§‹çµ„ç¹”</td>
             ${tableExampleRow.replace('å…­ç´šåˆ† / 95', 'å››ç´šåˆ† / 85').replace('+5', '-2')}
            <td class="px-4 py-2">æ®µè½åˆ†æ˜ï¼Œä½†æ®µè½ä¹‹é–“çš„é€£çµå¯ä»¥æ›´æµæš¢ã€‚</td>
        </tr>
        <tr class="bg-gray-50 border-b">
            <td class="px-4 py-2 whitespace-nowrap">é£è©é€ å¥</td>
             ${tableExampleRow.replace('å…­ç´šåˆ† / 95', 'å››ç´šåˆ† / 87').replace('+5', 'Â±0')}
            <td class="px-4 py-2">è©èªé‹ç”¨å¾—ä¸éŒ¯ï¼Œå¯ä»¥å¤šå˜—è©¦ä¸€äº›è®Šæ›ã€‚</td>
        </tr>
        <tr class="bg-white">
            <td class="px-4 py-2 rounded-bl-lg whitespace-nowrap">éŒ¯åˆ¥å­—èˆ‡æ¨™é»</td>
             ${tableExampleRow.replace('å…­ç´šåˆ† / 95', 'äº”ç´šåˆ† / 90').replace('+5', '+3')}
            <td class="px-4 py-2 rounded-br-lg">å¹¾ä¹æ²’æœ‰éŒ¯å­—ï¼Œéå¸¸ç´°å¿ƒï¼</td>
        </tr>
    </tbody>
</table>
\`\`\`

ğŸ‘ å°ä½œå®¶æ•´ç¯‡ä½œæ–‡å„ªé»ï¼š
ãƒ»[æ¢åˆ—å¼èªªæ˜å„ªé»]

ğŸ’ª æœªä¾†å¯ä»¥æ›´å¥½çš„åœ°æ–¹ï¼š
ãƒ»[æ¢åˆ—å¼èªªæ˜å¯ä»¥å†é€²æ­¥çš„åœ°æ–¹]
`;

                const responseText = await callGemini(prompt, feedbackElement);

                if (responseText) {
                    const scoreMatch = responseText.match(/<!-- SCORES_JSON: (.*) -->/);
                    if (scoreMatch && scoreMatch[1]) {
                        try {
                            const newScores = JSON.parse(scoreMatch[1]);
                            previousFullEssayScores = newScores;
                            const cleanedText = responseText.replace(/<!-- SCORES_JSON: .* -->/, '').trim();
                            feedbackElement.innerHTML = cleanedText;
                            
                            // å„²å­˜å…¨æ–‡æ‰¹æ”¹æ­·ç¨‹
                            fullEssayHistory.push({ text: fullText, feedback: cleanedText });
                            
                            displayRadarChart(newScores, 'å…¨æ–‡');

                        } catch (e) {
                            console.error("Failed to parse scores JSON from AI response:", e);
                            feedbackElement.innerHTML = responseText.replace(/<!-- SCORES_JSON: .* -->/, '').trim();
                        }
                    } else {
                         feedbackElement.innerHTML = responseText;
                         // å„²å­˜æ²’æœ‰åˆ†æ•¸çš„æ­·ç¨‹
                         fullEssayHistory.push({ text: fullText, feedback: responseText });
                    }
                }
            }


            initializeApp();
        });
    </script>
</body>
</html>

